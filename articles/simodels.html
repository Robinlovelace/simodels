<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Spatial interaction models with R • simodels</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Spatial interaction models with R">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">simodels</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/simodels.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/sims-first-principles.html">An introduction to spatial interaction models: from first principles</a></li>
    <li><a class="dropdown-item" href="../articles/validation.html">Validation of spatial interaction models</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/robinlovelace/simodels/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Spatial interaction models with R</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/robinlovelace/simodels/blob/main/vignettes/simodels.Rmd" class="external-link"><code>vignettes/simodels.Rmd</code></a></small>
      <div class="d-none name"><code>simodels.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<p>You need to have <a href="https://cran.r-project.org/" class="external-link">installed
R</a> and a suitable editor such as <a href="https://posit.co/download/rstudio-desktop/" class="external-link">RStudio</a> or <a href="https://github.com/REditorSupport/vscode-R" class="external-link">VSCode with R
plugin</a>. See the package’s <a href="https://robinlovelace.github.io/simodels/">README</a> for
instructions on installing the {simodels} package.</p>
<!--#  Test the necessary packages are installed by loading them (we will also use {dplyr}):-->
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/robinlovelace/simodels" class="external-link">simodels</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="input-data">Input data<a class="anchor" aria-label="anchor" href="#input-data"></a>
</h2>
<p>This tutorial builds on a <a href="https://github.com/adamdennett/SIModelling/blob/SIModelling-Edits/SimAus2.Rmd" class="external-link">reproducible</a>
guide to SIMs in R <span class="citation">(Dennett 2018)</span>. We
start by importing open access data representing movement between zones
in Australia (thanks to Adam Dennett for making the files
accessible):</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># To get the data (pre-loaded in the package)</span></span>
<span><span class="va">u1</span> <span class="op">=</span> <span class="st">"https://github.com/Robinlovelace/simodels/releases/download/0.0.1/zones_aus.geojson"</span></span>
<span><span class="va">zones_aus</span> <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">u1</span><span class="op">)</span></span>
<span><span class="va">u2</span> <span class="op">=</span> <span class="st">"https://www.dropbox.com/s/wi3zxlq5pff1yda/AusMig2011.csv?raw=1"</span></span>
<span><span class="va">od_aus</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">u2</span><span class="op">)</span></span></code></pre></div>
<p>Let’s take a quick look at and ‘minimize’ these input datasets before
modelling them with SIMs:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">zones_aus</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">zones_aus</span><span class="op">)</span></span>
<span><span class="va">key_zone_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"GCCSA_CODE"</span>, <span class="st">"GCCSA_NAME"</span>, <span class="st">"AREA_SQKM"</span><span class="op">)</span></span>
<span><span class="va">zones</span> <span class="op">=</span> <span class="va">zones_aus</span><span class="op">[</span><span class="va">key_zone_names</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">zones</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">od_aus</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">od_aus</span><span class="op">)</span></span>
<span><span class="va">key_od_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Orig_code"</span>, <span class="st">"Dest_code"</span>, <span class="st">"Flow"</span><span class="op">)</span></span>
<span><span class="va">od</span> <span class="op">=</span> <span class="va">od_aus</span><span class="op">[</span><span class="va">key_od_names</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">od</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>The results printed above show that:</p>
<ul>
<li><p><code>zones_aus</code> represents the 15 regions of Australia,
with columns containing zone identifiers (IDs), primarily
<code>GCCSA_CODE</code>, and the area of each zone
(<code>AREA_SQKM</code>). The minimal <code>zones</code> object contains
only the region code, name, and area.</p></li>
<li><p><code>od_aus</code> contains 225 rows of data representing the
movement of people between the zones in <code>aus</code>. Note that 255
is 15 squared, meaning that this OD dataset contains the complete
combination of migration flows, starting with zone <code>1GSYD</code> to
<code>1GSYD</code>. These codes are present in the
<code>GCCSA_CODE</code> column in the <code>aus</code> object. The first
row of the OD dataset represents ‘intra-zonal’ migrations in Greater
Sydney, presumably counting the number of people who move house from
somewhere in the region to another home in the region. There are 13
columns in this dataset, the most important of which are
<code>Orig_code</code>, <code>Dest_code</code>, and <code>Flow</code>,
which we have captured in the minimal <code>od</code> dataset.</p></li>
</ul>
<p>Note: a useful convention with ‘long form’ OD datasets is for the
first two columns to contain zone IDs that correspond to values in the
first column of the zone dataset. The R package <a href="https://itsleeds.github.io/od/" class="external-link">{od}</a>, on which {simodels}
builds, assumes that inputs to its functions are in this form.</p>
<p>It is a good idea to verify that the origin and destination codes in
the <code>od</code> dataset match the zone codes in
<code>zones</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">od</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">zones</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">od</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">zones</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>It is clear from the above that we have ‘clean’ input datasets, let’s
begin with the modelling!</p>
</div>
<div class="section level2">
<h2 id="preparing-a-sim">Preparing a SIM<a class="anchor" aria-label="anchor" href="#preparing-a-sim"></a>
</h2>
<p>Key to the workings of the {simodels} package is the conversion of
geographic objects representing origins and destinations into an OD
dataset. In this case, we already have an OD dataset, so this step is
less relevant. However, we will take this step in any case because many
SIMs start without such a comprehensive OD dataset as we have in this
case.</p>
<p>Prepare the OD dataset as follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_sim</span> <span class="op">=</span> <span class="fu"><a href="../reference/si_to_od.html">si_to_od</a></span><span class="op">(</span>origins <span class="op">=</span> <span class="va">zones</span>, destinations <span class="op">=</span> <span class="va">zones</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">od_sim</span><span class="op">)</span></span></code></pre></div>
<p>Note that the output has duplicate columns: <code><a href="../reference/si_to_od.html">si_to_od()</a></code>
joins data from the origin and destination objects into the resulting OD
object.</p>
</div>
<div class="section level2">
<h2 id="an-unconstrained-sim">An unconstrained SIM<a class="anchor" aria-label="anchor" href="#an-unconstrained-sim"></a>
</h2>
<p>A simplistic SIM - in this case an inverse power distance decay
function (negative exponential is another commonly used decay function)
- can be created just based on the distance between points:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">si_power</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">beta</span><span class="op">)</span> <span class="op">(</span><span class="va">d</span> <span class="op">/</span> <span class="fl">1000</span><span class="op">)</span><span class="op">^</span><span class="va">beta</span></span>
<span><span class="va">od_calculated</span> <span class="op">=</span> <span class="fu"><a href="../reference/si_calculate.html">si_calculate</a></span><span class="op">(</span></span>
<span>  <span class="va">od_sim</span>,</span>
<span>  fun <span class="op">=</span> <span class="va">si_power</span>,</span>
<span>  d <span class="op">=</span> <span class="va">distance_euclidean</span>,</span>
<span>  beta <span class="op">=</span> <span class="op">-</span><span class="fl">0.8</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">od_calculated</span><span class="op">[</span><span class="st">"interaction"</span><span class="op">]</span>, logz <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>This approach, ignoring all variables at the level of trip origins
and destinations, results in flow estimates with no units. Before
learning how to run constrained SIMs, let’s scale the result by the
total flow and see how far we are from reality, just focussing on the
interzonal OD pairs:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_interzonal</span> <span class="op">=</span> <span class="va">od</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Orig_code</span> <span class="op">!=</span> <span class="va">Dest_code</span><span class="op">)</span></span>
<span><span class="va">od_calculated_interzonal</span> <span class="op">=</span> <span class="va">od_calculated</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">O</span> <span class="op">!=</span> <span class="va">D</span><span class="op">)</span> </span>
<span><span class="va">scale_factor</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">od_interzonal</span><span class="op">$</span><span class="va">Flow</span><span class="op">)</span> <span class="op">/</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">od_calculated_interzonal</span><span class="op">$</span><span class="va">interaction</span><span class="op">)</span></span>
<span><span class="va">od_calculated_interzonal</span> <span class="op">=</span> <span class="va">od_calculated_interzonal</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>interaction_scaled <span class="op">=</span> <span class="va">interaction</span> <span class="op">*</span> <span class="va">scale_factor</span><span class="op">)</span></span>
<span><span class="va">od_joined</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span></span>
<span>  <span class="va">od_calculated_interzonal</span>,</span>
<span>  <span class="va">od</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>O <span class="op">=</span> <span class="va">Orig_code</span>, D <span class="op">=</span> <span class="va">Dest_code</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">od_joined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">Flow</span>, <span class="va">interaction_scaled</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">od_joined</span><span class="op">$</span><span class="va">Flow</span>, <span class="va">od_joined</span><span class="op">$</span><span class="va">interaction_scaled</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span></code></pre></div>
<p>The results show that a simple unconstrained model, without any
parameter fitting, can explain less than 20% of the variability in
flows. We can do better!</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_joined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>decay <span class="op">=</span> <span class="va">distance_euclidean</span><span class="op">^</span><span class="op">-</span><span class="fl">0.8</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>decay <span class="op">=</span> <span class="va">decay</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Flow</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">decay</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">distance_euclidean</span>, <span class="va">Flow</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">distance_euclidean</span>, <span class="va">decay</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> </span></code></pre></div>
</div>
<div class="section level2">
<h2 id="a-production-constrained-sim">A production constrained SIM<a class="anchor" aria-label="anchor" href="#a-production-constrained-sim"></a>
</h2>
<p>The first logical way to improve model fit is to run a production
constrained model. To do that, we’ll first calculate the total number of
people leaving each zone and then use the
<code>constraint_production</code> argument:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_originating</span> <span class="op">=</span> <span class="va">od_joined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">O</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>originating_per_zone <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Flow</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_constrained_p</span> <span class="op">=</span> <span class="fu"><a href="../reference/si_calculate.html">si_calculate</a></span><span class="op">(</span></span>
<span>  <span class="va">od_originating</span>,</span>
<span>  fun <span class="op">=</span> <span class="va">si_power</span>,</span>
<span>  d <span class="op">=</span> <span class="va">distance_euclidean</span>,</span>
<span>  beta <span class="op">=</span> <span class="op">-</span><span class="fl">0.8</span>,</span>
<span>  constraint_production <span class="op">=</span> <span class="va">originating_per_zone</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">od_constrained_p</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">Flow</span>, <span class="va">interaction</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">od_constrained_p</span><span class="op">$</span><span class="va">Flow</span>, <span class="va">od_constrained_p</span><span class="op">$</span><span class="va">interaction</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span></code></pre></div>
<p>Progress! We have more than doubled the predictive ability of our
model by using a ‘production constrained’ SIM, as defined mathematically
in the <a href="https://robinlovelace.github.io/simodels/articles/sims-first-principles.html"><code>simodels-first-principles</code>
vignette</a>.</p>
</div>
<div class="section level2">
<h2 id="training-a-sim">Training a SIM<a class="anchor" aria-label="anchor" href="#training-a-sim"></a>
</h2>
<p>An advantage of the flow data used in this example is that we already
know the interaction. (This raises the question of why a SIM is needed,
answer: to test our models and demonstrate the techniques.)</p>
<p>We can do this using the <code><a href="https://rdrr.io/r/stats/nls.html" class="external-link">nls()</a></code> function as follows:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">minpack.lm</span><span class="op">)</span></span>
<span><span class="va">f</span> <span class="op">=</span> <span class="va">Flow</span> <span class="op">~</span> <span class="va">a</span> <span class="op">*</span> <span class="op">(</span><span class="va">distance_euclidean</span><span class="op">)</span><span class="op">^</span><span class="va">b</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/minpack.lm/man/nlsLM.html" class="external-link">nlsLM</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">f</span>,</span>
<span>  data <span class="op">=</span> <span class="va">od_originating</span>,</span>
<span>  <span class="op">)</span></span>
<span><span class="va">m</span></span>
<span><span class="co"># Nonlinear regression model</span></span>
<span><span class="co">#   model: Flow ~ a * (distance_euclidean)^b</span></span>
<span><span class="co">#    data: od_originating</span></span>
<span><span class="co">#          a          b </span></span>
<span><span class="co">#  2.182e+07 -5.801e-01 </span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_joined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>decay <span class="op">=</span> <span class="va">distance_euclidean</span><span class="op">^</span><span class="op">-</span><span class="fl">5.801e-01</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>decay <span class="op">=</span> <span class="va">decay</span> <span class="op">*</span> <span class="fl">2.182e+07</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">distance_euclidean</span>, <span class="va">Flow</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">distance_euclidean</span>, <span class="va">decay</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> </span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_pred</span> <span class="op">=</span> <span class="fu"><a href="../reference/si_predict.html">si_predict</a></span><span class="op">(</span><span class="va">od_originating</span>, model <span class="op">=</span> <span class="va">m</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">od_pred</span><span class="op">$</span><span class="va">Flow</span>, <span class="va">od_pred</span><span class="op">$</span><span class="va">interaction</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="va">od_pred_const</span> <span class="op">=</span> <span class="fu"><a href="../reference/si_predict.html">si_predict</a></span><span class="op">(</span><span class="va">od_originating</span>, model <span class="op">=</span> <span class="va">m</span>,</span>
<span>  constraint_production <span class="op">=</span> <span class="va">originating_per_zone</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">od_pred_const</span><span class="op">$</span><span class="va">Flow</span>, <span class="va">od_pred_const</span><span class="op">$</span><span class="va">interaction</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-tmap.github.io/tmap/" class="external-link">tmap</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tmap_mode.html" class="external-link">ttm</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">od_pred_const</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_lines.html" class="external-link">tm_lines</a></span><span class="op">(</span><span class="st">"interaction_scaled"</span>, palette <span class="op">=</span> <span class="st">"viridis"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-dennett_modelling_2018" class="csl-entry">
Dennett, Adam. 2018. <span>“Modelling Population Flows Using Spatial
Interaction Models.”</span> <em>Australian Population Studies</em> 2
(2): 33–58. <a href="https://doi.org/10.37970/aps.v2i2.38" class="external-link">https://doi.org/10.37970/aps.v2i2.38</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Robin Lovelace, Jakub Nowosad.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
